{% extends 'scanner/base.html' %}

{% block content %}
<div class="scanner-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><span class="text-muted">History for</span> {{ symbol }}</h2>
        <a href="/" class="btn btn-outline-secondary">Back to Table</a>
    </div>

    <div style="height: 500px;">
        <canvas id="fundingChart"></canvas>
    </div>
</div>

{{ chart_data|json_script:"chart-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dataElement = document.getElementById('chart-data');
        
        if (dataElement) {
            const chartData = JSON.parse(dataElement.textContent);
            const ctx = document.getElementById('fundingChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // 'nearest' лучше подходит, когда у бирж разное количество точек
                    interaction: {
                        intersect: false,
                        mode: 'nearest',
                        axis: 'x'
                    },
                    scales: {
                        x: { 
                            type: 'time',
                            time: {
                                // Автоматически подбирает масштаб (час/день)
                                tooltipFormat: 'yyyy-MM-dd HH:mm',
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'MMM dd'
                                }
                            },
                            ticks: { 
                                color: '#848e9c', 
                                maxTicksLimit: 15,
                                autoSkip: true 
                            },
                            grid: { color: '#2a2e39' }
                        },
                        y: { 
                            ticks: { color: '#848e9c' },
                            grid: { color: '#2a2e39' },
                            title: { display: true, text: 'APR %', color: '#848e9c' }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: { color: '#eaecef', padding: 20 } 
                        },
                        tooltip: {
                            backgroundColor: '#1e2329',
                            titleColor: '#f0b90b',
                            bodyColor: '#eaecef',
                            borderColor: '#474d57',
                            borderWidth: 1,
                            padding: 10,
                            // Включаем отображение всех точек в тултипе даже в режиме nearest
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(4) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}